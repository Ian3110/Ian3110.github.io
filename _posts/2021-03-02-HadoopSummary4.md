---
layout: post
title: "HDFS 파일 I/O 흐름"
categories:
- Hadoop
---

사용자가 데이터 투입할 때는 HDFS 클라이언트를 사용함.<br/>
HDFS 클라이언트는 네임 노드와 처음으로 통신하며 어떤 데이터 노드와 작업하면 되는지 파악함.<br/>
실제 데이터 교환은 네임 노드를 통하지 않고 데이터 노드와 직접 함.<br/>
파일을 읽고 쓸 때 클라이언트와 데이터 노드가 직접 데이터를 교환하며 디스크 I/O도 데이터 노드가 수행함.<br/><br/><br/><br/>

## HDFS에 파일 저장하기
---

### 1)	클라이언트와 네임 노드 통신
-	클라이언트는 네임 노드에게 저장을 위한 파일 열기를 요청함. 그리고 네임 노드에 파일 작성을 요구함.<br/><br/>
-	요구를 접수한 네임 노드는 허가 용량 체크를 하고 파일을 저장할 수 있는 상태인지 확인한 후 메타 데이터에 파일 엔트리를 삽입함.<br/><br/>
-   클라이언트는 데이터 전송 큐 감시<br/><br/><br/>

### 2)	저장 개시
-	클라이언트가 저장용 스트림을 받으면 클라이언트가 파일 저장을 시작함. 받은 데이터를 패킷 단위로 데이터 전송 큐에 삽입함.<br/><br/>
-	별도 스레드로 데이터 전송 큐를 감시하고 데이터 전송 큐 안에 패킷이 들어간 것을 확인하면 네임 노드에 블록 할당을 요구함.<br/><br/>
-	패킷 저장 대상 데이터 노드 리스트를 수신함.<br/><br/>
-	이 리스트에서 복제 수와 동일 수의 데이터 노드를 연결한 파이프라인을 형성함. 데이터 전송 큐에서 패킷을 꺼내 파이프라인의 선두에 있는 데이터 노드에 기록함. 동시에 별도 스레드로 관리하고 있는 ack 대기 큐에 패킷을 저장함.<br/><br/><br/>

### 3)	패킷 전달
-	패킷이 기록된 데이터 노드는 파이프라인에 포함된 다른 데이터 노드에 패킷을 전달함.<br/><br/>
-	두 번째 복제본을 전달할 때, 첫 번째 복제본이 저장된 데이터 노드와 다른 랙에 있는 데이터 노드에 패킷을 전달함. 세 번째 복제본은 두 번째 복제본이 저장된 데이터 노드와 같은 랙에 있는 데이터 노드에 전달됨.<br/><br/>
-  	패킷이 정상적으로 기록된 데이터 노드는 ack 메시지를 파이프라인의 상위부에 통지함. ack 메시지는 최종적으로 클라이언트에 도착함.<br/><br/>
-	ack가 도착하면 대응 패킷이 ack 대기 큐에서 제거됨.<br/><br/><br/><br/>


## HDFS에서 파일 읽기
---

### 1)	클라이언트와 네임노드 통신
-	HDFS에서 파일을 읽을 때는 네임 노드에 읽기 전용 파일 열기를 요청함. 요구한 파일의 블록을 가진 데이터 노드 리스트를 요청함.<br/><br/>
-	클라이언트로부터 요청을 받은 네임노드는 오픈 때 부여한 파일 경로에서 해당 파일을 구성하는 블록 리스트를 생성함. 해당 블록을 가지고 있는 데이터 노드 리스트를 반환함.<br/><br/>
-	각 블록은 replication에 의해 복수의 데이터 노드에 배치되지만, 여기는 각 블록에 해당하는 데이터 노드의 위치가 클라이언트에 가까운 순으로 정렬됨.<br/><br/><br/>

### 2)	읽기 개시
-	클라이언트는 최초 블록을 가진 데이터 노드에 접속하여     블록을 읽음.<br/><br/>
-	블록을 읽을 때 클라이언트와 거리가 가장 가까운 데이터 노드를 선택함. 블록의 마지막 부분까지 읽으면 다음 블록을 가진 데이터 노드에 접속하여 다시 블록을 읽음.<br/><br/>
-	이것을 반복하여 파일 읽기를 끝내면 클라이언트는 파일 닫기를 요청함.<br/><br/>
